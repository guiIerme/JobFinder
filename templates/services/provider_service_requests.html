{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitações de Serviço - Job Finder{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Solicitações de Serviço</h1>
      
      <!-- Service Requests List -->
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Solicitações Pendentes</h5>
        </div>
        <div class="card-body">
          <div id="serviceRequestsContainer">
            <!-- Service requests will be loaded here via AJAX -->
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
              <p class="mt-2">Carregando solicitações...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Accept/Reject Modal -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="actionModalLabel">Responder Solicitação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="actionForm">
          <input type="hidden" id="requestId">
          <input type="hidden" id="actionType">
          
          <div class="mb-3">
            <label for="responseMessage" class="form-label">Mensagem (Opcional)</label>
            <textarea class="form-control" id="responseMessage" rows="3"></textarea>
          </div>
          
          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="actionSubmitBtn">Confirmar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Load service requests
  loadServiceRequests();
  
  // Handle form submission
  document.getElementById('actionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const requestId = document.getElementById('requestId').value;
    const actionType = document.getElementById('actionType').value;
    const message = document.getElementById('responseMessage').value;
    
    // Show loading state
    const submitBtn = document.getElementById('actionSubmitBtn');
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...';
    submitBtn.disabled = true;
    
    // Send request to server
    fetch(`/update-service-request-status/${requestId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({
        action: actionType,
        rejection_reason: message
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('actionModal'));
        modal.hide();
        
        // Reload service requests
        loadServiceRequests();
        
        // Show success message
        alert(data.message);
      } else {
        alert('Erro: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erro ao processar solicitação. Por favor, tente novamente.');
    })
    .finally(() => {
      // Reset button
      submitBtn.innerHTML = 'Confirmar';
      submitBtn.disabled = false;
    });
  });
});

function loadServiceRequests() {
  fetch('{% url "provider_service_requests" %}')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        renderServiceRequests(data.service_requests);
      } else {
        document.getElementById('serviceRequestsContainer').innerHTML = 
          '<div class="alert alert-danger">Erro ao carregar solicitações: ' + data.message + '</div>';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('serviceRequestsContainer').innerHTML = 
        '<div class="alert alert-danger">Erro ao carregar solicitações. Por favor, tente novamente.</div>';
    });
}

function renderServiceRequests(requests) {
  const container = document.getElementById('serviceRequestsContainer');
  
  if (requests.length === 0) {
    container.innerHTML = '<div class="text-center py-5"><p class="text-muted">Nenhuma solicitação pendente.</p></div>';
    return;
  }
  
  let html = '';
  requests.forEach(request => {
    html += `
      <div class="border rounded-3 p-4 mb-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5>${request.title}</h5>
            <p class="text-muted">${request.description}</p>
            
            <div class="row">
              <div class="col-md-6">
                <p><strong>Categoria:</strong> ${request.category}</p>
                <p><strong>Data/Hora:</strong> ${new Date(request.scheduled_date).toLocaleString('pt-BR')}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Cliente:</strong> ${request.customer_name}</p>
                <p><strong>Status:</strong> <span class="badge bg-warning">${request.status}</span></p>
              </div>
            </div>
            
            <p><strong>Endereço:</strong> ${request.address}</p>
            ${request.notes ? `<p><strong>Observações:</strong> ${request.notes}</p>` : ''}
          </div>
          
          <div class="d-flex flex-column gap-2">
            <button class="btn btn-success btn-sm" onclick="openActionModal(${request.id}, 'accept')">
              <i class="fas fa-check"></i> Aceitar
            </button>
            <button class="btn btn-danger btn-sm" onclick="openActionModal(${request.id}, 'reject')">
              <i class="fas fa-times"></i> Recusar
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function openActionModal(requestId, actionType) {
  document.getElementById('requestId').value = requestId;
  document.getElementById('actionType').value = actionType;
  document.getElementById('responseMessage').value = '';
  
  const modalTitle = document.getElementById('actionModalLabel');
  const submitBtn = document.getElementById('actionSubmitBtn');
  
  if (actionType === 'accept') {
    modalTitle.textContent = 'Aceitar Solicitação';
    submitBtn.textContent = 'Aceitar';
    submitBtn.className = 'btn btn-success';
  } else {
    modalTitle.textContent = 'Recusar Solicitação';
    submitBtn.textContent = 'Recusar';
    submitBtn.className = 'btn btn-danger';
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('actionModal'));
  modal.show();
}
</script>
{% endblock %}