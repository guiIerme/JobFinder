{% extends 'base.html' %}
{% load static %}

{% block title %}Mapa de Profissionais - Job Finder{% endblock %}

{% block extra_css %}
<style>
.map-container {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    position: relative;
    background: linear-gradient(135deg, #6f42c1 0%, #4361ee 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
}

.professional-card {
    border: 1px solid #dee2e6;
    border-radius: 12px;
    margin-bottom: 1rem;
    transition: all 0.3s ease-in-out;
}

.professional-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.rating-stars .fas {
    color: #ffc107;
}

.distance-slider-container {
    padding: 0 15px;
}

/* Fallback content styles */
.fallback-content {
    max-width: 80%;
    padding: 2rem;
}

.fallback-content h3 {
    color: white;
    margin-bottom: 1rem;
}

.fallback-content p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 1.5rem;
}

.fallback-content .btn {
    background-color: white;
    color: #6f42c1;
    border: none;
    font-weight: 600;
    border-radius: 10px;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease-in-out;
}

.fallback-content .btn:hover {
    background-color: rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center p-4 mb-4 stats-icon modern-hover-lift mx-auto">
                <i class="fas fa-map-marked-alt fa-2x text-primary"></i>
            </div>
            <h1 class="mb-3 fw-bold">Mapa de Profissionais</h1>
            <p class="lead text-muted">Encontre profissionais qualificados próximos à sua localização</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Filters sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="modern-card filter-card">
                <div class="modern-card-header bg-primary text-white">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-filter me-2"></i>
                        <span>Filtros</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filter-form" class="needs-validation" novalidate>
                        <div class="mb-4">
                            <label for="service-category" class="form-label fw-bold">
                                <i class="fas fa-th-large me-1"></i>
                                Categoria de Serviço
                            </label>
                            <div class="modern-input-group input-group rounded-pill overflow-hidden shadow-sm">
                                <span class="input-group-text bg-light border-0">
                                    <i class="fas fa-list text-primary"></i>
                                </span>
                                <select class="modern-form-control form-select border-end-0 rounded-pill" id="service-category">
                                    <option value="">Todas as categorias</option>
                                    <option value="repair">Reparos</option>
                                    <option value="assembly">Montagem</option>
                                    <option value="plumbing">Encanamento</option>
                                    <option value="electrical">Elétrica</option>
                                    <option value="cleaning">Limpeza</option>
                                    <option value="painting">Pintura</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="max-distance" class="form-label fw-bold">
                                <i class="fas fa-ruler me-1"></i>
                                Distância Máxima: <span id="distance-value" class="fw-bold">50</span> km
                            </label>
                            <div class="distance-slider-container">
                                <input type="range" class="form-range" id="max-distance" min="5" max="100" step="5" value="50">
                            </div>
                        </div>
                        
                        <button type="submit" class="modern-btn modern-btn-primary w-100 rounded-pill fw-bold py-3">
                            <i class="fas fa-sync-alt me-2"></i>
                            Atualizar Resultados
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Map placeholder and results -->
        <div class="col-lg-9">
            <div class="modern-card">
                <div class="card-body">
                    <!-- Map placeholder with explanation -->
                    <div class="map-container mb-4 rounded-3">
                        <div class="fallback-content">
                            <div class="bg-white bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center p-4 mb-4 stats-icon modern-hover-lift mx-auto">
                                <i class="fas fa-map-marked-alt fa-2x text-white"></i>
                            </div>
                            <h3 class="d-flex align-items-center justify-content-center fw-bold mb-4">
                                <i class="fas fa-map-marked-alt me-2"></i>
                                <span>Mapa Interativo</span>
                            </h3>
                            <p class="mb-4">Para visualizar o mapa interativo com a localização dos profissionais, é necessário uma chave válida da API do Google Maps.</p>
                            <p class="mb-4">Você ainda pode ver a lista de profissionais disponíveis na sua região abaixo.</p>
                            <button class="modern-btn modern-btn-light rounded-pill px-4 py-2 fw-bold" onclick="loadNearbyProfessionals()">
                                <i class="fas fa-sync-alt me-2"></i>Carregar Profissionais
                            </button>
                            <div class="mt-4">
                                <small class="text-white-50">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Para uso em produção, substitua a chave da API do Google Maps no arquivo base.html
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="mb-4 d-flex align-items-center fw-bold">
                        <i class="fas fa-users me-2 text-primary"></i>
                        <span>Profissionais Próximos</span>
                    </h3>
                    
                    <div id="professionals-list">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2">Buscando profissionais próximos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let professionalsData = [];

// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    
    // Set up event listeners
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        loadNearbyProfessionals();
    });
    
    document.getElementById('max-distance').addEventListener('input', function() {
        document.getElementById('distance-value').textContent = this.value;
    });
    
    // Load professionals immediately
    setTimeout(function() {
        console.log('Loading professionals list');
        loadNearbyProfessionals();
    }, 500);
});

// Load nearby professionals
function loadNearbyProfessionals() {
    console.log('Loading nearby professionals...');
    
    // Show loading indicator
    document.getElementById('professionals-list').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Buscando profissionais próximos...</p>
        </div>
    `;
    
    // Get filter values
    const category = document.getElementById('service-category').value;
    const maxDistance = document.getElementById('max-distance').value;
    
    // Build query parameters
    const params = new URLSearchParams();
    if (category) params.append('category', category);
    params.append('max_distance', maxDistance);
    
    console.log('Fetching professionals with params:', params.toString());
    
    // Fetch nearby professionals
    fetch(`{% url "get_nearby_professionals" %}?${params.toString()}`)
        .then(response => {
            console.log('Response received:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            if (data.success) {
                professionalsData = data.professionals;
                displayProfessionalsList();
            } else {
                console.warn('Error loading professionals:', data.error);
                document.getElementById('professionals-list').innerHTML = 
                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-1"></i>Não foi possível carregar os profissionais. ' + (data.message || data.error) + '</div>';
            }
        })
        .catch(error => {
            console.error('Error loading professionals:', error);
            document.getElementById('professionals-list').innerHTML = 
                '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-1"></i>Erro ao carregar profissionais. Por favor, tente novamente.</div>';
        });
}

// Display professionals in the list
function displayProfessionalsList() {
    console.log('Displaying professionals in list...');
    const container = document.getElementById('professionals-list');
    
    if (professionalsData.length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Nenhum profissional encontrado com os filtros selecionados.</div>';
        return;
    }
    
    let html = '';
    
    professionalsData.forEach(professional => {
        html += `
            <div class="professional-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title">${professional.name}</h5>
                            <div class="rating-stars mb-2">
                                ${generateStars(professional.rating)}
                                <span class="text-muted">(${professional.review_count} avaliações)</span>
                            </div>
                            ${professional.distance ? `<p class="mb-1"><i class="fas fa-map-marker-alt me-1"></i> ${professional.distance} km de distância</p>` : ''}
                        </div>
                        <div class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewProfessionalProfile(${professional.id})">
                                <i class="fas fa-user me-1"></i>Ver Perfil
                            </button>
                        </div>
                    </div>
                    
                    ${professional.services && professional.services.length > 0 ? `
                        <div class="mt-3">
                            <h6 class="mb-2">Serviços Oferecidos:</h6>
                            <div class="row">
                                ${professional.services.map(service => `
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>${service.name}</span>
                                            <span class="text-primary">R$ ${service.price ? service.price.toFixed(2) : '0.00'}</span>
                                        </div>
                                        <small class="text-muted">${service.category}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    console.log('Successfully displayed', professionalsData.length, 'professionais in list');
}

// Generate star rating HTML
function generateStars(rating) {
    let stars = '';
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5;
    
    for (let i = 1; i <= 5; i++) {
        if (i <= fullStars) {
            stars += '<i class="fas fa-star"></i>';
        } else if (i === fullStars + 1 && halfStar) {
            stars += '<i class="fas fa-star-half-alt"></i>';
        } else {
            stars += '<i class="far fa-star"></i>';
        }
    }
    
    return stars;
}

// View professional profile
function viewProfessionalProfile(professionalId) {
    window.location.href = `/provider/${professionalId}/`;
}
</script>
{% endblock %}