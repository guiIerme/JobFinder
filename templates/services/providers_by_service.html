{% extends 'base.html' %}
{% load static %}

{% block title %}Prestadores de {{ category_name }} - Job Finder{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6f42c1;
        --primary-light: #8a6ece;
        --primary-dark: #5a32a3;
        --secondary-color: #4e73df;
        --success-color: #1cc88a;
        --info-color: #36b9cc;
        --warning-color: #f6c23e;
        --danger-color: #e74a3b;
        --dark-color: #5a5c69;
        --light-color: #f8f9fc;
        --border-radius: 12px;
        --box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        --transition: all 0.3s ease-in-out;
        --gradient-primary: linear-gradient(135deg, #6f42c1, #4e73df);
        --gradient-secondary: linear-gradient(135deg, #4e73df, #36b9cc);
        --gradient-success: linear-gradient(135deg, #1cc88a, #36b9cc);
        --gradient-warning: linear-gradient(135deg, #f6c23e, #f6c23e);
        --gradient-danger: linear-gradient(135deg, #e74a3b, #e74a3b);
    }

    .provider-card {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
        margin-bottom: 1.5rem;
        background: white;
        border-top: 4px solid var(--primary-color);
    }

    .provider-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        border-top: 4px solid var(--primary-light);
    }

    .stats-icon {
        transition: var(--transition);
    }

    .stats-icon:hover {
        transform: scale(1.1);
    }

    .hover-lift {
        transition: var(--transition);
    }

    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .modern-badge {
        font-weight: 600;
        transition: var(--transition);
    }

    .modern-badge:hover {
        transform: scale(1.05);
    }

    .modern-btn {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
        border: none;
        min-height: calc(2.5rem + 2px);
    }

    .modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .modern-btn-primary {
        background: var(--gradient-primary);
        color: white;
    }

    .modern-btn-primary:hover {
        background: var(--primary-dark);
        color: white;
    }

    .modern-btn-outline {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        background-color: transparent;
    }

    .modern-btn-outline:hover {
        background: var(--gradient-primary);
        color: white;
    }

    .modern-card {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
        overflow: hidden;
    }

    .modern-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .modern-input-group {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d3e2;
        transition: var(--transition);
        margin-bottom: 1rem;
        background-color: #f8f9fc;
        min-height: calc(2.5rem + 2px);
    }

    .modern-input-group:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
        background-color: white;
    }

    .form-control-modern {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d3e2;
        transition: var(--transition);
        margin-bottom: 1rem;
        background-color: #f8f9fc;
        min-height: calc(2.5rem + 2px);
    }

    .form-control-modern:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
        background-color: white;
    }

    .category-header {
        background: var(--gradient-primary);
        border-radius: var(--border-radius);
        color: white;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
    }

    .category-header:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .category-header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
        transform: rotate(30deg);
    }

    .category-icon {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }

    .filter-card {
        border-radius: var(--border-radius);
        border: none;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
        margin-bottom: 2rem;
        overflow: hidden;
        background: white;
    }

    .filter-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .filter-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e3e6f0;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        font-weight: 700;
    }

    .filter-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e3e6f0;
    }

    .filter-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .filter-section-title {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-light);
        display: flex;
        align-items: center;
    }

    .filter-option-label {
        display: block;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid #e3e6f0;
    }

    .filter-option-label:hover {
        background-color: #f8f9fc;
        border-color: var(--primary-light);
    }

    .filter-option-input:checked+.filter-option-label {
        background-color: rgba(111, 66, 193, 0.1);
        border-color: var(--primary-color);
    }

    .filter-option-input:checked+.filter-option-label::after {
        content: "✓";
        float: right;
        color: var(--primary-color);
        font-weight: bold;
    }

    .star-rating-full {
        color: #f6c23e;
    }

    .star-rating-empty {
        color: #d1d3e2;
    }

    @media (max-width: 768px) {
        .category-header {
            padding: 1.5rem;
        }

        .modern-btn {
            padding: 0.6rem 1rem;
        }

        .provider-card {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Início</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Prestadores de {{ category_name }}</li>
                </ol>
            </nav>

            <div class="category-header mb-5">
                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-4 position-relative">
                    <div class="position-relative z-1">
                        <div class="d-flex align-items-center mb-3">
                            <a href="{% url 'home' %}" class="btn btn-light rounded-circle me-3 shadow" aria-label="Voltar para a página inicial">
                                <i class="fas fa-arrow-left text-primary"></i>
                            </a>
                            <div>
                                <h1 class="mb-0 fw-bold">
                                    <i class="fas fa-{% if category == 'repair' %}wrench{% elif category == 'assembly' %}tools{% elif category == 'plumbing' %}faucet{% elif category == 'electrical' %}plug{% elif category == 'cleaning' %}broom{% elif category == 'painting' %}paint-roller{% elif category == 'carpentry' %}hammer{% elif category == 'gardening' %}seedling{% elif category == 'pest_control' %}bug{% elif category == 'air_conditioning' %}snowflake{% elif category == 'locksmith' %}key{% elif category == 'moving' %}truck-moving{% else %}concierge-bell{% endif %} me-2"></i>
                                    Prestadores de {{ category_name }}
                                </h1>
                                <p class="mb-0 opacity-90">{{ providers.paginator.count }} profissionais encontrados</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sorting Options -->
                    <div class="position-relative z-1">
                        <div class="d-flex align-items-center bg-white rounded-pill px-3 py-2 shadow-sm border">
                            <label for="sort-select" class="me-2 text-nowrap mb-0 fw-medium text-primary">Ordenar por:</label>
                            <select class="form-control form-control-modern form-select form-select-sm border-0 fw-medium" id="sort-select" aria-label="Ordenar resultados por">
                                <option value="rating">Melhor avaliados</option>
                                <option value="price-low">Menor preço</option>
                                <option value="price-high">Maior preço</option>
                                <option value="newest">Mais recentes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-4">
            <div class="filter-card shadow border-0 sticky-top overflow-hidden" style="top: 80px;" role="region" aria-label="Filtros de busca">
                <div class="filter-header bg-primary text-white py-3">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-filter me-2"></i>
                        <span>Filtros</span>
                        <button class="btn btn-sm ms-auto" id="clear-filters" aria-label="Limpar todos os filtros">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </h5>
                </div>
                <div class="filter-body">
                    <!-- Search Filter -->
                    <div class="filter-section">
                        <h6 class="filter-section-title">
                            <i class="fas fa-search"></i>
                            <span>Buscar</span>
                        </h6>
                        <div class="input-group mb-3 rounded-pill overflow-hidden">
                            <span class="input-group-text bg-light border-0">
                                <i class="fas fa-search text-primary"></i>
                            </span>
                            <input type="text" class="form-control form-control-modern border-end-0" placeholder="Buscar por nome..." id="search-filter" aria-label="Buscar profissionais">
                            <button class="btn modern-btn modern-btn-outline rounded-pill rounded-start border-start-0" type="button" id="search-filter-btn" aria-label="Pesquisar">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Rating Filter -->
                    <div class="filter-section">
                        <h6 class="filter-section-title">
                            <i class="fas fa-star"></i>
                            <span>Avaliação</span>
                        </h6>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="rating" id="any-rating" value="" checked>
                            <label class="filter-option-label form-check-label" for="any-rating">
                                Qualquer avaliação
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="rating" id="rating-5" value="5">
                            <label class="filter-option-label form-check-label" for="rating-5">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <span class="ms-2">5 estrelas</span>
                                </div>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="rating" id="rating-4" value="4">
                            <label class="filter-option-label form-check-label" for="rating-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-empty me-1"></i>
                                    <span class="ms-2">4+ estrelas</span>
                                </div>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="rating" id="rating-3" value="3">
                            <label class="filter-option-label form-check-label" for="rating-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-full me-1"></i>
                                    <i class="fas fa-star star-rating-empty me-1"></i>
                                    <i class="fas fa-star star-rating-empty me-1"></i>
                                    <span class="ms-2">3+ estrelas</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Price Range Filter -->
                    <div class="filter-section">
                        <h6 class="filter-section-title">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Faixa de Preço</span>
                        </h6>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="price" id="any-price" value="" checked>
                            <label class="filter-option-label form-check-label" for="any-price">
                                Qualquer preço
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="price" id="price-1" value="0-100">
                            <label class="filter-option-label form-check-label" for="price-1">
                                Até R$ 100
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="price" id="price-2" value="100-300">
                            <label class="filter-option-label form-check-label" for="price-2">
                                R$ 100 - R$ 300
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="filter-option-input form-check-input" type="radio" name="price" id="price-3" value="300+">
                            <label class="filter-option-label form-check-label" for="price-3">
                                Acima de R$ 300
                            </label>
                        </div>
                    </div>

                    <!-- Apply Filters Button -->
                    <div class="d-grid gap-2">
                        <button class="modern-btn modern-btn-outline rounded-pill py-2 fw-bold" id="reset-filters">
                            <i class="fas fa-undo me-1"></i> Resetar
                        </button>
                        <button class="modern-btn modern-btn-primary rounded-pill py-2 fw-bold" id="apply-filters">
                            <i class="fas fa-filter me-1"></i> Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="col-lg-8">
            {% if providers %}
            <div class="row">
                {% for provider in providers %}
                {% with provider.custom_services.first as sample_service %}
                <div class="col-md-6 col-xl-4 mb-4">
                    <div class="provider-card h-100 border-0 shadow hover-lift position-relative overflow-hidden">
                        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(114, 9, 183, 0.03) 100%);"></div>
                        <div class="card-header bg-white position-relative z-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    {% if provider.userprofile.avatar %}
                                    <img src="{{ provider.userprofile.avatar.url }}" alt="Profile Picture" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3 stats-icon modern-hover-lift" style="width: 50px; height: 50px; color: white; font-weight: bold; font-size: 1.2rem;">
                                        {{ provider.first_name|slice:":1"|default:"U" }}{{ provider.last_name|slice:":1"|default:"U" }}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h5 class="card-title mb-0 fw-bold">{{ provider.get_full_name|default:provider.username }}</h5>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-star text-warning me-1"></i>
                                            <span class="small">
                                                {% if provider.userprofile.rating %}
                                                {{ provider.userprofile.rating|floatformat:1 }}
                                                {% else %}
                                                4.5
                                                {% endif %}
                                                ({% if provider.userprofile.review_count %}{{ provider.userprofile.review_count }}{% else %}12{% endif %} avaliações)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <span class="modern-badge bg-primary rounded-pill px-3 py-1">Profissional</span>
                            </div>
                        </div>
                        <div class="card-body position-relative z-1">
                            {% if sample_service %}
                            <div class="service-info mb-4">
                                <h6 class="text-muted mb-2 fw-bold">Serviço de Exemplo:</h6>
                                <p class="mb-2 fw-bold">{{ sample_service.name }}</p>
                                <p class="text-muted small mb-3">{{ sample_service.description|truncatewords:10 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary fs-5">R$ {{ sample_service.estimated_price|floatformat:2 }}</span>
                                    <span class="modern-badge bg-secondary rounded-pill px-3 py-1">{{ sample_service.get_category_display }}</span>
                                </div>
                            </div>
                            {% endif %}

                            <div class="provider-features mb-4">
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="modern-badge bg-success rounded-pill px-3 py-1">Garantia</span>
                                    <span class="modern-badge bg-success rounded-pill px-3 py-1">Materiais inclusos</span>
                                    <span class="modern-badge bg-success rounded-pill px-3 py-1">Orçamento grátis</span>
                                </div>
                            </div>

                            <div class="provider-location mb-3">
                                <div class="d-flex align-items-center text-muted">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <span>{{ provider.userprofile.city|default:"São Paulo" }}, {{ provider.userprofile.state|default:"SP" }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white position-relative z-1">
                            <div class="d-grid gap-2">
                                <a href="{% url 'solicitar_servico_completo' %}?id={{ sample_service.id }}&nome={{ sample_service.name|urlencode }}&descricao={{ sample_service.description|urlencode }}&preco={{ sample_service.estimated_price }}" class="btn btn-primary rounded-pill w-100">
                                    <i class="fas fa-concierge-bell me-2"></i> Solicitar Serviço
                                </a>
                                <a href="{% url 'provider_profile' provider.id %}" class="modern-btn modern-btn-outline rounded-pill px-4 py-2">
                                    <i class="fas fa-user me-2"></i> Ver Perfil
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if providers.has_other_pages %}
            <div class="mt-5">
                <nav aria-label="Navegação da página">
                    <ul class="pagination justify-content-center">
                        {% if providers.has_previous %}
                        <li class="page-item">
                            <a class="page-link rounded-pill" href="?page={{ providers.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Anterior">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}

                        {% for num in providers.paginator.page_range %}
                        {% if providers.number == num %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link rounded-pill bg-primary border-primary">{{ num }}</span>
                        </li>
                        {% elif num > providers.number|add:'-3' and num < providers.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link rounded-pill" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if providers.has_next %}
                        <li class="page-item">
                            <a class="page-link rounded-pill" href="?page={{ providers.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Próximo">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5>Nenhum prestador encontrado para {{ category_name }}</h5>
                <p class="text-muted">Não há prestadores disponíveis nesta categoria no momento.</p>
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <a href="{% url 'home' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-1"></i> Voltar aos Serviços
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const applyFiltersBtn = document.getElementById('apply-filters');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');

        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', function() {
                // Get selected filters
                const rating = document.querySelector('input[name="rating"]:checked') ? .value || '';
                const price = document.querySelector('input[name="price"]:checked') ? .value || '';
                const search = document.getElementById('search-filter') ? .value || '';

                // Build query string
                const params = new URLSearchParams(window.location.search);

                if (rating) {
                    params.set('rating', rating);
                } else {
                    params.delete('rating');
                }

                if (price) {
                    params.set('price_min', price.split('-')[0] || '');
                    if (price.includes('-')) {
                        params.set('price_max', price.split('-')[1] || '');
                    } else if (price === '300+') {
                        params.set('price_min', '300');
                        params.delete('price_max');
                    } else {
                        params.delete('price_max');
                    }
                } else {
                    params.delete('price_min');
                    params.delete('price_max');
                }

                if (search) {
                    params.set('search', search);
                } else {
                    params.delete('search');
                }

                // Redirect with filters
                window.location.search = params.toString();
            });
        }

        // Reset filters
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                // Reset all filters
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = radio.value === '';
                });
                document.getElementById('search-filter').value = '';
            });
        }

        // Clear filters
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                // Reset all filters and redirect without filters
                const params = new URLSearchParams(window.location.search);
                params.delete('rating');
                params.delete('price_min');
                params.delete('price_max');
                params.delete('search');

                // Keep the category parameter but remove others
                const category = params.get('category');
                window.location.search = category ? `category=${category}` : '';
            });
        }
    });
</script>

<!-- Service Request Modal -->
{% if user.is_authenticated %}
{% include 'services/service_request_modal.html' %}
{% endif %}

{% endblock %}