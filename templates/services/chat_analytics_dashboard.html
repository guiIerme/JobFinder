{% extends 'base.html' %}
{% load static %}

{% block title %}Chat Analytics Dashboard - Sophie{% endblock %}

{% block extra_css %}
<style>
    .analytics-dashboard {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-header {
        margin-bottom: 30px;
    }

    .dashboard-header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .time-filter {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .time-filter button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }

    .time-filter button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .metric-card h3 {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
    }

    .metric-subtitle {
        font-size: 0.85rem;
        color: #999;
        margin-top: 5px;
    }

    .metric-card.primary .metric-value {
        color: #007bff;
    }

    .metric-card.success .metric-value {
        color: #28a745;
    }

    .metric-card.warning .metric-value {
        color: #ffc107;
    }

    .metric-card.danger .metric-value {
        color: #dc3545;
    }

    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chart-card h3 {
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .topics-list {
        list-style: none;
        padding: 0;
    }

    .topics-list li {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }

    .topics-list li:last-child {
        border-bottom: none;
    }

    .topic-name {
        font-weight: 500;
    }

    .topic-count {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
    }

    .sessions-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .sessions-table h3 {
        padding: 20px;
        margin: 0;
        border-bottom: 1px solid #eee;
    }

    .sessions-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .sessions-table th,
    .sessions-table td {
        padding: 12px 20px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .sessions-table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .sessions-table tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.closed {
        background: #f8d7da;
        color: #721c24;
    }

    .user-type-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        background: #e7f3ff;
        color: #004085;
    }

    .engagement-score {
        font-weight: bold;
    }

    .engagement-score.high {
        color: #28a745;
    }

    .engagement-score.medium {
        color: #ffc107;
    }

    .engagement-score.low {
        color: #dc3545;
    }

    .rating-stars {
        color: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <div class="dashboard-header">
        <h1>游늵 Chat Analytics Dashboard - Sophie</h1>
        <p>Monitoring chat sessions and performance metrics</p>

        <div class="time-filter">
            <button class="{% if days == 1 %}active{% endif %}" onclick="window.location.href='?days=1'">Last 24h</button>
            <button class="{% if days == 7 %}active{% endif %}" onclick="window.location.href='?days=7'">Last 7 days</button>
            <button class="{% if days == 30 %}active{% endif %}" onclick="window.location.href='?days=30'">Last 30 days</button>
            <button class="{% if days == 90 %}active{% endif %}" onclick="window.location.href='?days=90'">Last 90 days</button>
        </div>

        <div class="export-buttons" style="margin-top: 15px;">
            <button onclick="exportData('sessions')" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                游닌 Export Sessions
            </button>
            <button onclick="exportData('messages')" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                游닌 Export Messages
            </button>
            <button onclick="exportData('analytics')" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                游닌 Export Analytics
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card primary">
            <h3>Active Sessions</h3>
            <div class="metric-value">{{ active_sessions }}</div>
            <div class="metric-subtitle">Currently active</div>
        </div>

        <div class="metric-card">
            <h3>Total Sessions</h3>
            <div class="metric-value">{{ total_sessions }}</div>
            <div class="metric-subtitle">In selected period</div>
        </div>

        <div class="metric-card success">
            <h3>Avg Response Time</h3>
            <div class="metric-value">{{ avg_response_time }}ms</div>
            <div class="metric-subtitle">Average AI response time</div>
        </div>

        <div class="metric-card warning">
            <h3>Satisfaction Rating</h3>
            <div class="metric-value">{{ avg_satisfaction }}/5</div>
            <div class="metric-subtitle">{{ satisfaction_count }} ratings</div>
        </div>

        <div class="metric-card success">
            <h3>Resolution Rate</h3>
            <div clatric-value">{{ resolution_rate }}%</div>
            <div class="metric-subtitle">{{ resolved_count }} resolved</div>
        </div>

        <div class="metric-card danger">
            <h3>Escalations</h3>
            <div class="metric-value">{{ escalated_count }}</div>
            <div class="metric-subtitle">To human support</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Top Topics -->
        <div class="chart-card">
            <h3>游댠 Top Topics Discussed</h3>
            {% if top_topics %}
            <ul class="topics-list">
                {% for topic, count in top_topics %}
                <li>
                    <span class="topic-name">{{ topic }}</span>
                    <span class="topic-count">{{ count }}</span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>No topics data available</p>
            {% endif %}
        </div>

        <!-- User Type Distribution -->
        <div class="chart-card">
            <h3>游논 User Type Distribution</h3>
            <ul class="topics-list">
                {% for stat in user_type_stats %}
                <li>
                    <span class="topic-name">{{ stat.user_type|title }}</span>
                    <span class="topic-count">{{ stat.count }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Recent Sessions Table -->
    <div class="sessions-table">
        <h3>Recent Chat Sessions</h3>
        <table>
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Messages</th>
                    <th>Avg Response</th>
                    <th>Engagement</th>
                    <th>Rating</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody>
                {% for item in session_data %}
                <tr>
                    <td><code>{{ item.session.session_id|truncatechars:12 }}</code></td>
                    <td>
                        {% if item.session.user %}
                        {{ item.session.user.username }}
                        {% else %}
                        Anonymous
                        {% endif %}
                    </td>
                    <td>
                        <span class="user-type-badge">{{ item.session.user_type }}</span>
                    </td>
                    <td>
                        {% if item.session.is_active %}
                        <span class="status-badge active">Active</span>
                        {% else %}
                        <span class="status-badge closed">Closed</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.analytics %}
                        {{ item.analytics.total_messages }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if item.analytics and item.analytics.average_response_time_ms %}
                        {{ item.analytics.average_response_time_ms|floatformat:0 }}ms
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if item.analytics %}
                        <span class="engagement-score {% if item.engagement_score >= 70 %}high{% elif item.engagement_score >= 40 %}medium{% else %}low{% endif %}">
                            {{ item.engagement_score }}
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if item.session.satisfaction_rating %}
                        <span class="rating-stars">
                            {% for i in "12345" %}
                            {% if forloop.counter <= item.session.satisfaction_rating %}驕{% else %}驕{% endif %}
                            {% endfor %}
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>{{ item.session.created_at|date:"M d, H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px;">
                        No sessions found in the selected period
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Auto-refresh active sessions count every 30 seconds
    setInterval(async function() {
        try {
            const response = await fetch('{% url "chat_analytics_api" %}');
            const data = await response.json();

            // Update active sessions if element exists
            const activeSessionsEl = document.querySelector('.metric-card.primary .metric-value');
            if (activeSessionsEl) {
                activeSessionsEl.textContent = data.active_sessions;
            }
        } catch (error) {
            console.error('Error refreshing analytics:', error);
        }
    }, 30000);

    // Export data function
    function exportData(type) {
        // Get current filter parameters
        const urlParams = new URLSearchParams(window.location.search);
        const days = urlParams.get('days') || '7';

        // Calculate date range
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - parseInt(days));

        // Format dates for URL
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];

        // Build export URL
        let exportUrl = '';
        if (type === 'sessions') {
            exportUrl = '{% url "export_chat_sessions" %}';
        } else if (type === 'messages') {
            exportUrl = '{% url "export_chat_messages" %}';
        } else if (type === 'analytics') {
            exportUrl = '{% url "export_chat_analytics" %}';
        }

        // Add date range parameters
        exportUrl += `?start_date=${startDateStr}&end_date=${endDateStr}`;

        // Open export URL in new window to trigger download
        window.open(exportUrl, '_blank');
    }
</script>
{% endblock %}