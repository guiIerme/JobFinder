<!-- Modal de Solicita√ß√£o de Servi√ßo -->
<div class="modal fade" id="modalSolicitarServico" tabindex="-1" aria-labelledby="modalSolicitarServicoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSolicitarServicoLabel">
                    <i class="fas fa-concierge-bell me-2"></i>
                    Solicitar Servi√ßo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√µes do Servi√ßo -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Detalhes do Servi√ßo</h6>
                    <div id="service-info">
                        <p><strong>Servi√ßo:</strong> <span id="service-name-display">-</span></p>
                        <p><strong>Descri√ß√£o:</strong> <span id="service-description-display">-</span></p>
                        <p><strong>Pre√ßo Estimado:</strong> R$ <span id="service-price-display">0,00</span></p>
                    </div>
                </div>

                <!-- Formul√°rio -->
                <form id="form-solicitar-servico">
                    {% csrf_token %}

                    <!-- Campos ocultos para dados do servi√ßo -->
                    <input type="hidden" id="service-id" name="service_id" value="">
                    <input type="hidden" id="service-name" name="service_name" value="">
                    <input type="hidden" id="service-description" name="service_description" value="">
                    <input type="hidden" id="service-price" name="estimated_price" value="">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact-name" class="form-label">
                                    <i class="fas fa-user me-1"></i>
                                    Nome Completo *
                                </label>
                                <input type="text" class="form-control" id="contact-name" name="contact_name" value="{% if user.is_authenticated %}{{ user.get_full_name }}{% endif %}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact-email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>
                                    E-mail *
                                </label>
                                <input type="email" class="form-control" id="contact-email" name="contact_email" value="{% if user.is_authenticated %}{{ user.email }}{% endif %}" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="contact-phone" class="form-label">
                            <i class="fas fa-phone me-1"></i>
                            Telefone *
                        </label>
                        <input type="tel" class="form-control" id="contact-phone" name="contact_phone" value="{% if user.is_authenticated %}{{ user.userprofile.phone }}{% endif %}" required>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">
                            <i class="fas fa-comment me-1"></i>
                            Observa√ß√µes Adicionais
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Descreva detalhes espec√≠ficos, hor√°rio preferido, etc."></textarea>
                    </div>

                    <!-- Feedback de Status -->
                    <div id="form-feedback" class="d-none">
                        <div id="success-message" class="alert alert-success d-none">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="success-text">Solicita√ß√£o enviada com sucesso!</span>
                        </div>
                        <div id="error-message" class="alert alert-danger d-none">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span id="error-text">Erro ao enviar solicita√ß√£o. Tente novamente.</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btn-enviar-solicitacao">
                    <i class="fas fa-paper-plane me-1"></i>
                    <span id="btn-text">Enviar Solicita√ß√£o</span>
                    <span id="btn-loading" class="d-none">
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        Enviando...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Fun√ß√£o global para solicitar servi√ßo
    window.solicitarServico = function(servicoId, nome, descricao, preco) {
        console.log('üöÄ solicitarServico chamada:', {
            servicoId,
            nome,
            descricao,
            preco
        });

        try {
            // Verificar se Bootstrap est√° carregado
            if (typeof bootstrap === 'undefined') {
                console.error('‚ùå Bootstrap n√£o est√° carregado');
                alert('Erro: Sistema n√£o est√° pronto. Recarregue a p√°gina.');
                return;
            }

            // Encontrar o modal
            const modal = document.getElementById('modalSolicitarServico');
            if (!modal) {
                console.error('‚ùå Modal n√£o encontrado');
                alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
                return;
            }

            // Garantir que os valores n√£o sejam undefined ou null
            const serviceId = servicoId || '';
            const serviceName = nome || 'Servi√ßo Personalizado';
            const serviceDescription = descricao || 'Descreva o que voc√™ precisa';
            const servicePrice = preco || '0.00';

            console.log('üìã Dados processados:', {
                serviceId,
                serviceName,
                serviceDescription,
                servicePrice
            });

            // Preencher campos ocultos do formul√°rio
            const serviceIdField = document.getElementById('service-id');
            const serviceNameField = document.getElementById('service-name');
            const serviceDescriptionField = document.getElementById('service-description');
            const servicePriceField = document.getElementById('service-price');

            if (serviceIdField) serviceIdField.value = serviceId;
            if (serviceNameField) serviceNameField.value = serviceName;
            if (serviceDescriptionField) serviceDescriptionField.value = serviceDescription;
            if (servicePriceField) servicePriceField.value = servicePrice;

            // Atualizar display visual
            const nameDisplay = document.getElementById('service-name-display');
            const descriptionDisplay = document.getElementById('service-description-display');
            const priceDisplay = document.getElementById('service-price-display');

            if (nameDisplay) nameDisplay.textContent = serviceName;
            if (descriptionDisplay) descriptionDisplay.textContent = serviceDescription;
            if (priceDisplay) {
                // Formatar pre√ßo para exibi√ß√£o brasileira
                const formattedPrice = parseFloat(servicePrice).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                priceDisplay.textContent = formattedPrice;
            }

            console.log('‚úÖ Campos preenchidos:', {
                serviceId: serviceIdField ? serviceIdField.value : 'N/A',
                serviceName: serviceNameField ? serviceNameField.value : 'N/A',
                serviceDescription: serviceDescriptionField ? serviceDescriptionField.value : 'N/A',
                servicePrice: servicePriceField ? servicePriceField.value : 'N/A'
            });

            // Limpar feedback anterior
            const feedbackDiv = document.getElementById('form-feedback');
            const successDiv = document.getElementById('success-message');
            const errorDiv = document.getElementById('error-message');

            if (feedbackDiv) feedbackDiv.classList.add('d-none');
            if (successDiv) successDiv.classList.add('d-none');
            if (errorDiv) errorDiv.classList.add('d-none');

            // Resetar bot√£o
            const btnEnviar = document.getElementById('btn-enviar-solicitacao');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');

            if (btnEnviar) btnEnviar.disabled = false;
            if (btnText) btnText.classList.remove('d-none');
            if (btnLoading) btnLoading.classList.add('d-none');

            console.log('‚úÖ Dados preenchidos, abrindo modal...');

            // Abrir modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            console.log('‚úÖ Modal aberto com sucesso!');

        } catch (error) {
            console.error('‚ùå Erro ao abrir modal:', error);
            alert('Erro ao abrir modal: ' + error.message);
        }
    };

    // Configurar evento de envio quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîß Configurando eventos do modal...');

        const btnEnviar = document.getElementById('btn-enviar-solicitacao');
        const form = document.getElementById('form-solicitar-servico');

        if (btnEnviar && form) {
            btnEnviar.addEventListener('click', function() {
                console.log('üì§ Bot√£o enviar clicado');
                enviarSolicitacao();
            });

            // Tamb√©m permitir envio via Enter no formul√°rio
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('üì§ Formul√°rio submetido via Enter');
                enviarSolicitacao();
            });

            console.log('‚úÖ Eventos configurados com sucesso');
        } else {
            console.error('‚ùå Elementos do formul√°rio n√£o encontrados');
        }
    });

    // Fun√ß√£o para enviar solicita√ß√£o via AJAX
    function enviarSolicitacao() {
        console.log('üöÄ Iniciando envio da solicita√ß√£o...');

        const form = document.getElementById('form-solicitar-servico');
        const btnEnviar = document.getElementById('btn-enviar-solicitacao');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const feedbackDiv = document.getElementById('form-feedback');
        const successDiv = document.getElementById('success-message');
        const errorDiv = document.getElementById('error-message');
        const successText = document.getElementById('success-text');
        const errorText = document.getElementById('error-text');

        // Validar campos obrigat√≥rios
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            console.log('‚ùå Campos obrigat√≥rios n√£o preenchidos');
            errorText.textContent = 'Por favor, preencha todos os campos obrigat√≥rios.';
            errorDiv.classList.remove('d-none');
            successDiv.classList.add('d-none');
            feedbackDiv.classList.remove('d-none');
            return;
        }

        // Mostrar loading
        btnEnviar.disabled = true;
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        feedbackDiv.classList.add('d-none');

        // Preparar dados
        const formData = new FormData(form);

        // Log detalhado dos dados que ser√£o enviados
        const dataToSend = {
            service_id: formData.get('service_id'),
            service_name: formData.get('service_name'),
            service_description: formData.get('service_description'),
            estimated_price: formData.get('estimated_price'),
            contact_name: formData.get('contact_name'),
            contact_email: formData.get('contact_email'),
            contact_phone: formData.get('contact_phone'),
            notes: formData.get('notes')
        };

        console.log('üìä Dados do formul√°rio que ser√£o enviados:', dataToSend);

        // Verificar se os dados do servi√ßo est√£o sendo enviados corretamente
        if (!dataToSend.service_name || dataToSend.service_name === 'Servi√ßo Personalizado') {
            console.warn('‚ö†Ô∏è Aten√ß√£o: service_name est√° vazio ou √© "Servi√ßo Personalizado"');
        }
        if (!dataToSend.service_description) {
            console.warn('‚ö†Ô∏è Aten√ß√£o: service_description est√° vazio');
        }
        if (!dataToSend.estimated_price || dataToSend.estimated_price === '0.00') {
            console.warn('‚ö†Ô∏è Aten√ß√£o: estimated_price est√° vazio ou √© 0.00');
        }

        // Enviar via AJAX
        console.log('üåê Enviando requisi√ß√£o para /solicitar-servico/...');

        fetch('/solicitar-servico/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('üì° Resposta recebida:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìã Dados da resposta:', data);

                // Resetar bot√£o
                btnEnviar.disabled = false;
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');

                if (data.success) {
                    console.log('‚úÖ Solicita√ß√£o enviada com sucesso!');

                    // Mostrar sucesso
                    successText.textContent = data.message || 'Solicita√ß√£o enviada com sucesso! Entraremos em contato em breve.';
                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    feedbackDiv.classList.remove('d-none');

                    // Fechar modal ap√≥s 3 segundos
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalSolicitarServico'));
                        if (modal) {
                            modal.hide();
                        }

                        // Limpar formul√°rio
                        form.reset();
                        feedbackDiv.classList.add('d-none');
                    }, 3000);

                } else {
                    console.log('‚ùå Erro na solicita√ß√£o:', data.message);

                    // Mostrar erro
                    errorText.textContent = data.message || 'Erro ao enviar solicita√ß√£o. Tente novamente.';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                    feedbackDiv.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro na requisi√ß√£o:', error);

                // Resetar bot√£o
                btnEnviar.disabled = false;
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');

                // Mostrar erro
                errorText.textContent = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                feedbackDiv.classList.remove('d-none');
            });
    }

    console.log('‚úÖ Modal de solicita√ß√£o carregado com sucesso');
</script>